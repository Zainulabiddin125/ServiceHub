@{
    ViewData["Title"] = "Fetch Attendance";
}

<style>
    .Cust-card-margin {
        margin: 5px !important;
    }

    .table {
        margin-bottom: 0 !important;
    }
</style>

<div class="row">
    <div class="col-lg-12">
        <div class="card Cust-card-margin">
            <div class="card-header">
                <div class="card-title">
                    <h3>Fetch and Transfer Employees</h3>
                </div>
            </div>
            <div class="card-body">
                <div class="row mt-3">
                    <div class="col-md-2">
                        <label for="machineIPs">Machine IP Address:</label>
                    </div>
                    <div class="col-md-3">
                        <select id="machineIPs" class="form-control" style="width: 100% !important;">
                            <option value="">-- Select Machine IP --</option>
                        </select>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-2">
                        <label for="employeeDropdown">Employees:</label>
                    </div>
                    <div class="col-md-3">
                        <select id="employeeDropdown" class="form-control" style="width: 100% !important;">
                            <option value="">-- Select Employee --</option>
                        </select>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-2">
                        <label for="destinationIP">Destination Machine IP:</label>
                    </div>
                    <div class="col-md-3">
                        <select id="destinationIP" class="form-control" style="width: 100% !important;">
                            <option value="">-- Select Destination IP --</option>
                        </select>
                    </div>
                </div>

                <button id="fetchButton" class="btn btn-primary mt-3">Fetch Employees</button>
                <button id="transferButton" class="btn btn-success mt-3" disabled>Transfer Employee</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Include Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Include Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {

                // Initialize Select2 on dropdowns
                $("#machineIPs").select2({
                    placeholder: "-- Select Machine IP --",
                    allowClear: true // Allow clearing the selection
                });

                $("#destinationIP").select2({
                    placeholder: "-- Select Destination IP --",
                    allowClear: true // Allow clearing the selection
                });

                $("#employeeDropdown").select2({
                    placeholder: "-- Select Employee --",
                    allowClear: true // Allow clearing the selection
                });

            // Load machine IPs into the dropdown
                $.get("/HR/TransferEmployee_API/GetMachineIPs", function (data) {
                data.forEach(function (ip) {
                    $("#machineIPs").append(`<option value="${ip}">${ip}</option>`);
                    $("#destinationIP").append(`<option value="${ip}">${ip}</option>`);
                });
            });

          // Fetch employees when a machine IP is selected
          $("#fetchButton").click(function () {
            var selectedIP = $("#machineIPs").val();
            if (!selectedIP) {
                alert("Please select a machine IP.");
                return;
            }
            $.ajax({
                    url: "/HR/TransferEmployee_API/GetEmployees",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify([selectedIP]),
                success: function (employees) {
                    // Ensure employees array is valid
                    if (!Array.isArray(employees) || employees.length === 0) {
                        alert("No employees found.");
                        return;
                    }
                    // Clear and populate the dropdown
                    $("#employeeDropdown").empty();
                    $("#employeeDropdown").append('<option value="">-- Select Employee --</option>');
                    // Append each employee by index
                    for (var i = 0; i < employees.length; i++) {
                        var employee = employees[i];
                        // Ensure empNo and empName exist and are not empty
                        if (employee.empNo && employee.empName) {
                            $("#employeeDropdown").append(
                                `<option value='${employee.empNo}'>${employee.empNo} - ${employee.empName}</option>`
                            );
                        }
                    }
                   // Refresh Select2 after appending options
                    $("#employeeDropdown").trigger("change");
                    alert("Employees fetched and appended successfully.");
                },
                error: function (xhr, status, error) {
                    alert("Failed to fetch employees: " + error);
                    // console.error("Error details:", xhr, status, error);
                }
            });
        });
            // Enable the transfer button when an employee is selected
            $("#employeeDropdown").change(function () {
                var selectedEmployee = $("#employeeDropdown").val();
                if (selectedEmployee) {
                    $("#transferButton").prop("disabled", false);
                } else {
                    $("#transferButton").prop("disabled", true);
                }
            });

       // Handle transfer button click
         $("#transferButton").click(function () {
            var sourceIP = $("#machineIPs").val();
            var destinationIP = $("#destinationIP").val();
            var EmpNo = $("#employeeDropdown").val();
            var selectedEmpName = $("#employeeDropdown option:selected").text();
            var EmpName = selectedEmpName.split(" - ")[1];

            // Validate inputs
            if (!sourceIP || !destinationIP || !EmpNo || !EmpName) {
                alert("Please select both Source and Destination IPs, and an employee.");
                return;
            }
           // Ensure source and destination IPs are different
            if (sourceIP === destinationIP) {
                alert("Source IP and Destination IP cannot be the same. Please select different IPs.");
                return;
            }

            // Prepare the transfer request payload
            var transferRequest = {
                SourceIP: sourceIP,
                DestinationIP: destinationIP,
                EmpNo: EmpNo,
                EmpName: EmpName,
            };

            // Send the transfer request to the backend
            $.ajax({
                url: "/HR/TransferEmployee_API/TransferEmployee",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(transferRequest),
                success: function (response) {
                    // Check if the response contains an error
                    if (response.message.includes("[ERROR]")) {
                        alert(response.message); // Display the error message
                    } else {
                        alert("Employee transferred successfully: " + response.message); // Success message
                    }
                // Refresh the page after the alert is dismissed
                location.reload();
                },
                error: function (xhr, status, error) {
                    // Handle transfer failure
                alert("Failed to transfer employee: " + xhr.responseText);
                // console.error("Error details:", xhr, status, error);
                // Refresh the page after the alert is dismissed
                location.reload();
                }
            });
        });
    });
    </script>
}