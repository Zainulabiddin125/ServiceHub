@{
    ViewData["Title"] = "Change Device Password";
}
<style>
    .Cust-card-margin {
        margin: 5px !important;
    }

    .time-window-alert {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 4px;
    }

    .time-window-open {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .time-window-closed {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>

<link href="~/css/select2.css" rel="stylesheet" />
<div class="row">
    <div class="col-lg-12">
        <div class="time-window-alert @(ViewBag.IsTransferWindowOpen ? "time-window-open" : "time-window-closed")">
            @ViewBag.TransferWindowMessage
            <div id="nextWindowChange"></div>
        </div>

        <div class="card Cust-card-margin">
            <div class="card-header">
                <div class="card-title">
                    <h2>Change Device User Password</h2>
                </div>
            </div>
            <div class="card-body">
                <div class="row mt-3">
                    <div class="col-md-2">
                        <label for="machineSelect">Select Machine :</label>
                    </div>
                    <div class="col-md-4">
                        <select id="machineSelect" class="form-control"></select>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-2">
                        <label for="port">Port:</label>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="port" class="form-control" readonly />
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-2">
                        <label>User ID:</label>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="userId" class="form-control" />
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-2">
                        <label>Old Password:</label>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="password" id="oldPassword" class="form-control" />
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="#oldPassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-2">
                        <label>New Password:</label>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="password" id="newPassword" class="form-control" />
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary toggle-password" type="button" data-target="#newPassword">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6 offset-md-2">
                        <button id="changePasswordBtn" class="btn btn-primary" @(ViewBag.IsTransferWindowOpen ? "" : "disabled")>                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/select2.js"></script>
    <script>
        function checkTransferWindow() {
            $.get("/HR/PasswordChange/CheckTransferWindow", function (data) {
                $("#changePasswordBtn").prop("disabled", !data.isOpen);
                $(".time-window-alert")
                    .toggleClass("time-window-open", data.isOpen)
                    .toggleClass("time-window-closed", !data.isOpen);

                if (data.nextCheckInMs) {
                    var mins = Math.floor(data.nextCheckInMs / 60000);
                    var secs = Math.floor((data.nextCheckInMs % 60000) / 1000);
                    var msg = data.isOpen
                        ? `Window closes in ${mins}m ${secs}s`
                        : `Next window opens in ${mins}m ${secs}s`;

                    $("#nextWindowChange").text(msg);

                    var checkDelay = Math.max(1000, data.nextCheckInMs - 1000);
                    setTimeout(checkTransferWindow, checkDelay);
                }
            });
        }

         $(document).on('click', '.toggle-password', function () {
            const targetInput = $($(this).data("target"));
            const icon = $(this).find('i');
            const isPassword = targetInput.attr("type") === "password";

            targetInput.attr("type", isPassword ? "text" : "password");
            icon.toggleClass("bi-eye bi-eye-slash");
        });

        $(document).ready(function () {
            $("#machineSelect").select2({
                placeholder: "-- Select Machine --",
                allowClear: true
            });

            checkTransferWindow();

            $.get("/HR/TransferEmployee_API/GetMachineIPs", function (ips) {
                ips.forEach(ip => {
                    $("#machineSelect").append(`<option value="${ip.value}">${ip.label}</option>`);
                });
            });

            $("#machineSelect").on("change", function () {
                const selectedIP = $(this).val();
                if (selectedIP) {
                    $.get(`/HR/PasswordChange/GetMachinePort?ip=${selectedIP}`, function (port) {
                        $("#port").val(port);
                    });
                } else {
                    $("#port").val("");
                }
            });

            $("#changePasswordBtn").click(function () {
                const ip = $("#machineSelect").val().trim();
                const port = parseInt($("#port").val());
                const userId = $("#userId").val();
                const oldPassword = $("#oldPassword").val().trim();
                const newPassword = $("#newPassword").val().trim();

                if (!ip || !userId || !oldPassword || !newPassword) {
                    alert("All fields are required.");
                    return;
                }

                $.ajax({
                    url: "/HR/PasswordChange/ChangePassword",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ ip, port, userId, oldPassword, newPassword }),
                    success: function (res) {
                        alert(res.message || "Password changed.");
                         location.reload();
                    },
                    error: function (err) {
                        alert("Error: " + err.responseText);
                    }
                });
            });
        });
    </script>
}
